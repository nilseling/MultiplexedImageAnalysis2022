---
title: "Multiplexed image analysis"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Install required packages

To follow the data analysis examples in this tutorial, you will need to 
install the following R packages:

```{r, eval=FALSE}
install.packages("BiocManager")
BiocManager::install(c("cytomapper", "imcRtools"))
```

Please also install [FIJI](https://imagej.net/software/fiji/) and [QuPATH](https://qupath.github.io/).

## Download example data {#download-data}

To highlight the basic steps of multiplexed image analysis, we provide example data that
were acquired as part of the **I**ntegrated i**MMU**noprofiling of large adaptive
**CAN**cer patient cohorts projects ([immucan.eu](https://immucan.eu/)). The
raw data of 4 patients can be accessed online at 
[zenodo.org/record/5949116](https://zenodo.org/record/5949116).
Image processing and segmentation has been performed using `steinbock` and we will only need to access the
sample/patient information here:

```{r download-sample-data}
download.file("https://zenodo.org/record/5949116/files/sample_metadata.xlsx", 
         destfile = "data/sample_metadata.xlsx")
```

### Processed multiplexed imaging data

The IMC raw data was processed using the 
[steinbock](https://github.com/BodenmillerGroup/steinbock) framework.
Image processing included file type conversion, cell segmentation and feature
extraction. 

**steinbock output**

The needed output of the `steinbock` framework includes the single-cell mean
intensity files, the single-cell morphological features and spatial locations,
spatial object graphs in form of edge lists indication cells in close proximity,
hot pixel filtered multi-channel images, segmentation masks, image metadata and
channel metadata. All these files will be downloaded here for easy access. The
commands which were used to process the data can be found in
`data/steinbock/steinbock.sh`.

```{r steinbock-results, warning=FALSE}
# download intensities
url <- "https://zenodo.org/record/6043600/files/intensities.zip"
destfile <- "data/steinbock/intensities.zip"
download.file(url, destfile)
unzip(destfile, exdir="data/steinbock", overwrite=TRUE)
unlink(destfile)

# download regionprops
url <- "https://zenodo.org/record/6043600/files/regionprops.zip"
destfile <- "data/steinbock/regionprops.zip"
download.file(url, destfile)
unzip(destfile, exdir="data/steinbock", overwrite=TRUE)
unlink(destfile)


# download neighbors
url <- "https://zenodo.org/record/6043600/files/neighbors.zip"
destfile <- "data/steinbock/neighbors.zip"
download.file(url, destfile)
unzip(destfile, exdir="data/steinbock", overwrite=TRUE)
unlink(destfile)

# download images
url <- "https://zenodo.org/record/6043600/files/img.zip"
destfile <- "data/steinbock/img.zip"
download.file(url, destfile)
unzip(destfile, exdir="data/steinbock", overwrite=TRUE)
unlink(destfile)

# download masks
url <- "https://zenodo.org/record/6043600/files/masks_deepcell.zip"
destfile <- "data/steinbock/masks_deepcell.zip"
download.file(url, destfile)
unzip(destfile, exdir="data/steinbock", overwrite=TRUE)
unlink(destfile)

# download individual files
download.file("https://zenodo.org/record/6043600/files/panel.csv", 
              "data/steinbock/panel.csv")
download.file("https://zenodo.org/record/6043600/files/images.csv", 
              "data/steinbock/images.csv")
download.file("https://zenodo.org/record/6043600/files/steinbock.sh", 
              "data/steinbock/steinbock.sh")
```

## Visualization of multiplexed images

FIJI and QuPATH

## Handling image and single-cell data in R

## Single-cell analysis

## Image visualization



